{% extends "base.html" %}

{% block content %}
    <div class="modal fade" id="lawModal" tabindex="-1" role="dialog" aria-labelledby="lawModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lawModalLabel">Detailed Law</h5>
                </div>
                <div class="modal-body" id="lawModalBody">
                    <!-- Law details will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" id="close-law-modal-btn" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% if session.betatest == True %}
        <div>
            <!-- Just testing, will further edit using modal -->
            <strong style="text-align:center">THIS IS A BETA TEST SESSION</strong>
        </div>
        <div class="modal fade" id="betaWelcomeModal" tabindex="-1" role="dialog" aria-labelledby="betaWelcomeModalLabel">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="betaWelcomeModalLabel">Welcome, fellow Beta Testers!</h5>
                    </div>
                    <div class="modal-body" id="betaWelcomeModalBody">
                        <p>Thank you for participating in our beta test on the legal chatbot!</p>
                        <p>We are currently testing the chatbot's handling of text and speech recognition in Nepali and Urdu languages.</p>
                        <p>For this test, please translate the question below the input box to your language.</p>
                        <p>You can use any translation tools to do so, but we highly encourage you to use your own wording.</p>
                        <p>After translating the question, you can proceed by typing or speaking your answer to the chatbot.</p>
                        <p>For typing, the chatbot only recognizes the original writing script, so please use the transliteration tool if you wish to type here directly. It is the same way as using Google IME found in their products like Google Translate: you type your words in English alphabets and it will provide a list of converted words in your language!</p>
                        <p>For speech recognition, please press the "Speak" button and speak into your microphone (it may prompt for granting access, press allow if asked), and press "Stop" when you finish the question.</p>
                        <p>The test will conclude when you finish the survey, which will pop up after you ask the chatbot a couple of questions.</p>
                        <br><br>
                        <p>Thank you once again for joining our test. Please proceed by selecting your language (Nepali or Urdu):</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="nepali-btn" class="btn btn-primary" data-bs-dismiss="modal">Nepali</button>
                        <button type="button" id="urdu-btn" class="btn btn-primary" data-bs-dismiss="modal">Urdu</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    <input type="hidden" id="lang" value="{{ session.lang }}">
    <input type="hidden" id="betatest" value="{{ session.betatest }}">
    <input type="hidden" id="betaModalIsShown" value="{{ session.betaModalIsShown }}">
    <div class="chat-container">
        <div class="chat-header">
            {% if lang == 'en' %}
                <h5>Chatbot Conversation</h5>
            {% elif lang == 'ne' %}
                <h5>च्याटबोट बार्तालाप</h5>
            {% elif lang == 'ur' %}
                <h5 dir="rtl">چیٹ بوٹ بات چیت</h5>
            {% elif lang == 'fil' %}
                <h5>Usapan ng Chatbot</h5>
            {% endif %}
        </div>
        <div class="chat-messages">
            <!-- chat messages will be rendered here -->
        </div>
        <div class="input-group">
            {% if lang == 'en' %}
                <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
            {% elif lang == 'ne' %}
                <input type="text" id="user-input" class="form-control" placeholder="तपाईँको सन्देश टाइप गर्नुहोस्...">
            {% elif lang == 'ur' %}
                <input type="text" id="user-input" class="form-control" dir="rtl" placeholder="اپنا پیغام ٹائپ کریں...">
            {% elif lang == 'fil' %}
                <input type="text" id="user-input" class="form-control" placeholder="Type mo ang message mo...">
            {% endif %}
            <button class="btn btn-primary" id="send-btn">
                {% if lang == 'en' %}
                    Send
                {% elif lang == 'ne' %}
                    पठाउनुहोस्
                {% elif lang == 'ur' %}
                    بھیج
                {% elif lang == 'fil' %}
                    Magpadala
                {% endif %}
            </button>
            <button class="btn btn-secondary" id="speech-btn">
                {% if lang == 'en' %}
                    Speak
                {% elif lang == 'ne' %}
                    बोल्नुहोस्
                {% elif lang == 'ur' %}
                    بولنا
                {% elif lang == 'fil' %}
                    Magsalita
                {%  endif %}
            </button>
        </div>
        {% if session.betatest == True %}
            <div id="questionToTranslate">
                <p>Question:</p>
                <p id="questionText"></p>
            </div>
        {% endif %}
        <div id="suggestions" class="suggestions-list" style="display: none;"></div>
        <br>
        <div class="transliteration_demo" {% if lang == 'en' or lang == 'fil' %}style="display: none;"{% endif %}> <!-- only ne and ur display transliteration button -->
            <span>Transliteration</span>
            <div class="toggle-button" id="transliteration-btn">
                <div class="toggle-circle"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="speech-modal" tabindex="-1" role="dialog" aria-labelledby="speech-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <p>Please speak into your microphone.</p>
                    <p>Press "Stop" button to end speech recognition</p>
                </div>
                <div class="modal-footer">
                    <button type="button" id="stop-speech-btn" class="btn btn-danger" data-bs-dismiss="modal">Stop</button>
                    <button type="button" id="cancel-speech-btn" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="surveyPopup" tabindex="-1" role="dialog" aria-labelledby="surveyPopupLabel" data-bs-backdrops="static">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    {% if session.betatest %}
                        <p>Please rate your experience with the chatbot so far.</p>
                    {% else %}
                        <p>Would you like to rate your experience with the chatbot so far?</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    {% if session.betatest %}
                        <button type="button" class="btn btn-primary" onclick="showSurvey()">Continue</button>
                    {% else %}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button type="button" class="btn btn-primary" onclick="showSurvey()">Yes</button>
                    {% endif %}
            </div>
        </div>
    </div>
    <script> 
        document.addEventListener('DOMContentLoaded', function () {
            var lang = document.getElementById('lang').value;
            var betatest = document.getElementById('betatest').value;
            var betaModalIsShown = document.getElementById('betaModalIsShown').value;
            const userInputField = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const speechBtn = document.getElementById('speech-btn');
            const chatMessagesDiv = document.querySelector('.chat-messages');
            const transliterationBtn = document.getElementById('transliteration-btn'); 
            const suggestionsDiv = document.getElementById('suggestions');
            const stopSpeechBtn = document.getElementById('stop-speech-btn');
            const cancelSpeechButton = document.getElementById('cancel-speech-btn');
            let randomResponses = Math.floor(Math.random() * 4) + 2; // 2-3 responses before survey popup
            let responseCount = 0;
            let isTransliterationOn = false;
            let currentSuggestionIndex = -1; // Track the currently highlighted suggestion
            let audio = null;
            let currentButton = null;
            let startTime;
            let documentId;
            let recognizer;
            let recognizedTextBuffer = '';

            if (betatest) {
                if (betaModalIsShown === 'False') {
                    $('#betaWelcomeModal').modal('show');
                }
                const nepaliBtn = document.getElementById('nepali-btn');
                const urduBtn = document.getElementById('urdu-btn');
                if (nepaliBtn) {
                    nepaliBtn.addEventListener('click', function() {
                        window.location.href = '/lang/ne';
                    });
                }
                if (urduBtn) {
                    urduBtn.addEventListener('click', function() {
                        window.location.href = '/lang/ur';
                    });
                }
            }

            renderSampleQuestion();

            function renderSampleQuestion() {
                if (betatest) {
                    fetch('/fetchSampleQuestion')
                    .then(response => response.json())
                    .then(data => {
                        const questionText = document.getElementById('questionText');
                        if (questionText) {
                            questionText.textContent = data.question;
                        }
                    })
                    .catch(error => console.error('Error fetching sample question: ', error));
                }
            }

            userInputField.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && userInputField.value.trim() != '') {
                    e.preventDefault();
                    sendBtn.click();
                }
            })

            sendBtn.addEventListener('click', () => {
                const userInput = userInputField.value.trim();
                if (userInput) {
                    renderUser(userInput);
                    startTime = performance.now();
                    sendRequestToPython('text', userInput);
                    userInputField.value = '';
                    suggestionsDiv.style.display = 'none';
                }
                if (betatest) {
                    questionText.textContent = '';
                }
            });
        
            function renderUser(userInput) {
                var langTexts = {
                    'en': 'You',
                    'ur': 'آپ',
                    'ne': 'तपाईं',
                    'fil': 'Iyo'
                };
                var userText = langTexts[lang];
                var messageHTML = `<div class="message user" style="direction: ${lang === 'ur' ? 'rtl' : 'ltr'}"><span style="direction:rtl;">${userText}</span><p>${userInput}</p></div>`;
                chatMessagesDiv.innerHTML += messageHTML;
            }
            
            function startRecognition() {
                fetch('/get_speech_config')
                    .then(response => response.json())
                    .then(data => {
                        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(data.subscriptionKey, data.region);
                        switch (lang) {
                            case 'en':
                                speechConfig.speechRecognitionLanguage = 'en-US';
                                break;
                            case 'ne':
                                speechConfig.speechRecognitionLanguage = 'ne-NP';
                                break;
                            case 'ur':
                                speechConfig.speechRecognitionLanguage = 'ur-IN';
                                break;
                            case 'fil':
                                speechConfig.speechRecognitionLanguage = 'fil-PH';
                                break;
                            default:
                                speechConfig.speechRecognitionLanguage = 'en-US';
                        }
                        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                        recognizer.recognizing = function(s, e) {
                            console.log(`RECOGNIZING: Text=${e.result.text}`);
                        };
                        recognizer.recognized = function(s, e) {
                            if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                                console.log(`RECOGNIZED: Text=${e.result.text}`);
                                recognizedTextBuffer += e.result.text + ' ';
                            } else if (e.result.reason === SpeechSDK.ResultReason.NoMatch) {
                                console.log('NOMATCH: Speech could not be recognized.');
                            }
                        };
                        recognizer.canceled = function(s, e) {
                            console.log(`CANCELED: Reason=${e.reason}`);
                            if (e.reason === SpeechSDK.CancellationReason.Error) {
                                console.log(`CANCELED: ErrorCode=${e.errorCode}`);
                                console.log(`CANCELED: ErrorDetails=${e.errorDetails}`);
                            }
                            recognizer.stopContinuousRecognitionAsync();
                        };
                        recognizer.sessionStopped = function(s, e) {
                            console.log("Session stopped.");
                            recognizer.stopContinuousRecognitionAsync();
                        };
            
                        recognizer.startContinuousRecognitionAsync();
                    })
                    .catch(error => console.error('Error fetching speech config:', error));
            }
            
            function stopRecognition() {
                if (recognizer) {
                    recognizer.stopContinuousRecognitionAsync(() => {
                        if (recognizedTextBuffer.trim() !== '') {
                            renderUser(recognizedTextBuffer.trim());
                            startTime = performance.now();
                            sendRequestToPython('speech', recognizedTextBuffer.trim());
                            recognizedTextBuffer = '';
                            if (betatest) {
                                questionText.textContent = '';
                            }
                        }
                    });
                }
            }

            speechBtn.addEventListener('click', () => {
                $('#speech-modal').modal('show');
                startRecognition();
            });

            stopSpeechBtn.addEventListener('click', () => {
                stopRecognition();
                console.log('Speech recognition stopped by user.');
                $('#speech-modal').modal('hide');
            });

            cancelSpeechButton.addEventListener('click', () => {
                if (recognizer) {
                    recognizer.stopContinuousRecognitionAsync(() => {
                        recognizedTextBuffer = '';
                        console.log('Speech recognition aborted by user.');
                        $('#speech-modal').modal('hide');
                    });
                }
            });
        
            function sendRequestToPython(inputType, userInput) {
                var langTexts = {
                    'en': 'Bot',
                    'ur': 'باٹ',
                    'ne': 'बोट',
                    'fil': 'Bot'
                };
                var botText = langTexts[lang];
        
                // Show loading indicator for chatbot response after 500ms
                setTimeout(() => {
                    var loadingHTML = `<div class="message bot loading" style="direction: ${lang === 'ur' ? 'rtl' : 'ltr'}"><span>${botText}</span><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
                    chatMessagesDiv.innerHTML += loadingHTML;
                }, 500);

                fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputType: inputType, userInput: userInput })
                })
                .then(response => response.json())
                .then(data => {
                    documentId = data.documentId;
                    console.log('Document ID: ', documentId);
                    renderResponse(data);
                })
                .catch(error => console.error(error));
            }

            function incrementResponseCount() {
                responseCount++;
                if (responseCount === randomResponses) {
                    $('#surveyPopup').modal('show');
                    randomResponses = Math.floor(Math.random() * 4) + 2; // Reset random respones number
                    responseCount = 0;
                }
            }
        
            function renderResponse(data) {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                console.log('Duration: ', duration);

                console.log('Document ID before update: ', data.documentId);
                // Update the duration in the database
                fetch('/update_duration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documentId: data.documentId, duration: duration })
                });

                // Create a new div for the response
                var responseDiv = document.createElement('div');
                responseDiv.id = `response ${data.documentId}`;
                responseDiv.className = 'message bot';
                responseDiv.classList.add('response-container');

                // Update the loading element with the actual response and TTS button
                var formattedResponse = data.response.replace(/\n/g, '<br>');
                var responseHTML = `
                    <span>${document.querySelector('.message.bot.loading span').innerHTML}</span>
                    <p>${formattedResponse}</p>
                    <button class="btn btn-success" onclick="handleTTS('${data.documentId}', \`${data.response}\`, this)">
                        <i class="fas fa-play"></i>
                    </button>
                `;
                responseDiv.innerHTML = responseHTML;

                // Append the responseDiv to the chatMessagesDiv
                chatMessagesDiv.appendChild(responseDiv);

                // Remove the loadingElement
                document.querySelector('.message.bot.loading').remove();

                // Add the law table toggle button
                if (data.retrieved && data.retrieved.length > 0) {
                    var toggleButtonHTML = `<button class="btn btn-info" onclick="toggleLawDetails('${data.documentId}')">Show Detailed Law</button>`;
                    responseDiv.innerHTML += toggleButtonHTML;
                }

                // Append the responseDiv to the chatMessagesDiv
                chatMessagesDiv.appendChild(responseDiv);

                incrementResponseCount();

                if (betatest) {
                    renderSampleQuestion();
                }
            }

            window.handleTTS = function(documentId, text, button) {
                if (button.dataset.audioUrl) {
                    toggleTTS(button.dataset.audioUrl, button);
                } else {
                    fetchTTS(documentId, text, button);
                }
            }
        
            function fetchTTS(documentId, text, button) {
                // Change button to grey with spinner
                button.innerHTML = '<div class="spinner-border spinner-border-sm text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');

                fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, lang: lang })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.audio_url) {
                        button.dataset.audioUrl = data.audio_url;
                        toggleTTS(data.audio_url, button);
                    } else {
                        console.error('TTS failed');
                        button.innerHTML = '<i class="fas fa-play"></i> TTS failed';
                        button.classList.remove('btn-secondary');
                        button.classList.add('btn-danger');
                    }
                })
                .catch(error => {
                    console.error(error);
                    button.innerHTML = '<i class="fas fa-play"></i> Error occurred';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-danger');
                });
            }

            function toggleTTS(audioUrl, button) {
                if (audio && !audio.paused) {
                    audio.pause();
                    button.innerHTML = '<i class="fas fa-play"></i>';
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-success');
                } else {
                    if (currentButton && currentButton !== button) {
                        currentButton.innerHTML = '<i class="fas fa-play"></i>';
                        currentButton.classList.remove('btn-danger');
                        currentButton.classList.add('btn-success');
                    }
                    currentButton = button;
                    audio = new Audio(audioUrl);
                    audio.play();
                    button.innerHTML = '<i class="fas fa-pause"></i>';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-danger');

                    audio.onended = () => {
                        button.innerHTML = '<i class="fas fa-play"></i>';
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-success');
                    };
                }
            }

            // Separate function to toggle the detailed law
            window.toggleLawDetails = function(documentId) {
                fetch(`/getLaws?documentId=${documentId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.laws && data.laws.length > 0) {
                            var lawsHTML = '';
                            data.laws.forEach(law => {
                                lawsHTML += `
                                    <div>
                                        <h4>Cap. ${law.law_id} (${law.law_chapter})</h4>
                                        <p>${law.law_text}</p>
                                    </div>
                                `;
                            });
                            document.getElementById('lawModalBody').innerHTML = lawsHTML;
                            $('#lawModal').modal('show');
                        } else {
                            console.error(`No law details found for documentId: ${documentId}`);
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching law details for documentId: ${documentId}`, error);
                    });
            };

            window.showSurvey = function() {
                const surveyPopup = $('#surveyPopup');
                surveyPopup.find('.modal-body').html(`
                    <div class="rating">
                    <span class="rate-message">Please rate your experience:</span>
                    <div class="category">
                        <span>Response Time (How long did you wait for the responses?):</span>
                        <div class="star d-flex align-items-center mt-2">
                        <div class="text-star">
                            <input type="radio" id="responseTime1" name="responseTime" data-value="1">
                            <label for="responseTime1" class="star-label">Poor</label>
                            <label for="responseTime1" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="responseTime2" name="responseTime" data-value="2">
                            <label for="responseTime2" class="star-label">Fair</label>
                            <label for="responseTime2" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="responseTime3" name="responseTime" data-value="3">
                            <label for="responseTime3" class="star-label">Good</label>
                            <label for="responseTime3" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="responseTime4" name="responseTime" data-value="4">
                            <label for="responseTime4" class="star-label">Very good</label>
                            <label for="responseTime4" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="responseTime5" name="responseTime" data-value="5">
                            <label for="responseTime5" class="star-label">Excellent</label>
                            <label for="responseTime5" class="bi bi-star-fill"></label>
                        </div>
                        </div>
                    </div>
                    <div class="category">
                        <span>Accuracy (Is the answers relevant to your questions?):</span>
                        <div class="star d-flex align-items-center mt-2">
                        <div class="text-star">
                            <input type="radio" id="accuracy1" name="accuracy" data-value="1">
                            <label for="accuracy1" class="star-label">Poor</label>
                            <label for="accuracy1" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="accuracy2" name="accuracy" data-value="2">
                            <label for="accuracy2" class="star-label">Fair</label>
                            <label for="accuracy2" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="accuracy3" name="accuracy" data-value="3">
                            <label for="accuracy3" class="star-label">Good</label>
                            <label for="accuracy3" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="accuracy4" name="accuracy" data-value="4">
                            <label for="accuracy4" class="star-label">Very good</label>
                            <label for="accuracy4" class="bi bi-star-fill"></label>
                        </div>
                        <div class="text-star">
                            <input type="radio" id="accuracy5" name="accuracy" data-value="5">
                            <label for="accuracy5" class="star-label">Excellent</label>
                            <label for="accuracy5" class="bi bi-star-fill"></label>
                        </div>
                        </div>
                    </div>
                    <div class="category">
                        <span>Do you have any other comments/suggestions? Feel free to write them here:</span>
                        <textarea id="userSuggestions" class="form-control mt-2" rows="3" placeholder="Enter your comments here..."></textarea>
                    </div>
                    </div>
                `);
                surveyPopup.find('.modal-footer').html(`
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitSurvey">Submit</button>
                `);
                surveyPopup.modal('show');
            
                document.getElementById('submitSurvey').addEventListener('click', function() {
                    const responseTimeRating = document.querySelector('input[name="responseTime"]:checked').getAttribute('data-value');
                    const accuracyRating = document.querySelector('input[name="accuracy"]:checked').getAttribute('data-value');
                    const userSuggestions = document.getElementById('userSuggestions').value;
            
                    fetch('/rate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ responseTime: responseTimeRating, accuracy: accuracyRating, suggestions: userSuggestions })
                    }).then(() => {
                        if (betatest) {
                            surveyPopup.find('.modal-body').html('<span class="thank-you-message">Thank you for your response! You may continue trying our chatbot, or close the tab to conclude the testing. Thank you once again to join our beta test!</span>');
                            surveyPopup.find('.modal-footer').html(
                                '<button type="button" class="btn btn-secondary" onclick="resetSurveyPopup()" data-bs-dismiss="modal">Continue</button>' + 
                                '<button type="button" class="btn btn-primary" onclick="endTesting()">End Testing</button>');
                        } else {
                            surveyPopup.find('.modal-body').html('<span class="thank-you-message">Thank you for your response!</span>');
                            surveyPopup.find('.modal-footer').html('<button type="button" class="btn btn-secondary" onclick="resetSurveyPopup()" data-bs-dismiss="modal">Close</button>');
                            setTimeout(() => {
                                surveyPopup.modal('hide');
                            }, 3000);
                        }
                    });
                });
            }

            window.resetSurveyPopup = function() {
                if (betatest) {
                    $('#surveyPopup').find('.modal-body').html(`
                        <p>Please rate your experience with the chatbot so far.</p>
                    `);
                    $('#surveyPopup').find('.modal-footer').html(`
                        <button type="button" class="btn btn-primary" onclick="showSurvey()">Continue</button>
                    `);
                } else {
                    $('#surveyPopup').find('.modal-body').html(`
                        <p>Would you like to rate your experience with the chatbot so far?</p>
                    `);
                    $('#surveyPopup').find('.modal-footer').html(`
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                        <button type="button" class="btn btn-primary" onclick="showSurvey()">Yes</button>
                    `);
                }
            }

            window.endTesting = function() {
                fetch('/betatest/close', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                }).then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                }).catch(error => console.error('Error ending beta test: ', error));
            }
        
            // Toggle transliteration on button click
            transliterationBtn.addEventListener('click', () => {
                isTransliterationOn = !isTransliterationOn;
                transliterationBtn.classList.toggle('active', isTransliterationOn);
                suggestionsDiv.style.display = 'none'; 
            });
            
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

             //Transliteration input function 
             userInputField.addEventListener('input', debounce(function() {
                const cursorPos = userInputField.selectionStart;
                const fullText = userInputField.value;
                const textBeforeCursor = fullText.substring(0, cursorPos);
                
                // Find the current word being edited
                const words = textBeforeCursor.split(/\s+/);
                const currentWord = words[words.length - 1];

                if (isTransliterationOn && currentWord) {
                    fetchTransliterationSuggestions(currentWord);
                } else {
                    suggestionsDiv.style.display = 'none';
                    suggestionsDiv.innerHTML = '';
                }
            }, 300));
 

             // Handle keydown events for space and arrow navigation
             userInputField.addEventListener('keydown', function(e) {
                const items = suggestionsDiv.querySelectorAll('.suggestion-item');
                if (isTransliterationOn && items.length > 0) {
                    if (e.key === 'ArrowDown') {
                        currentSuggestionIndex = (currentSuggestionIndex + 1) % items.length;
                        highlightSuggestion(currentSuggestionIndex);
                        e.preventDefault();
                    } else if (e.key === 'ArrowUp') {
                        currentSuggestionIndex = (currentSuggestionIndex - 1 + items.length) % items.length;
                        highlightSuggestion(currentSuggestionIndex);
                        e.preventDefault();
                    } else if (e.key === ' ') {
                        if (currentSuggestionIndex >= 0) {
                            e.preventDefault();
                            const selectedSuggestion = items[currentSuggestionIndex].textContent.trim();
                            const cursorPos = userInputField.selectionStart;
                            const fullText = userInputField.value;
                            const textBeforeCursor = fullText.substring(0, cursorPos);
                            const textAfterCursor = fullText.substring(cursorPos);
                            const wordsBefore = textBeforeCursor.split(/(\s+)/);
                            const lastSegment = wordsBefore[wordsBefore.length - 1];
                            const newTextBefore = textBeforeCursor.substring(0, textBeforeCursor.length - lastSegment.length) + selectedSuggestion;
                            userInputField.value = newTextBefore + textAfterCursor;
                            const newCursorPos = newTextBefore.length;
                            userInputField.setSelectionRange(newCursorPos, newCursorPos);
                            suggestionsDiv.style.display = 'none';
                            currentSuggestionIndex = -1;
                            suggestionsDiv.innerHTML = '';
                        }
                    }
                }
            });

            //highlighting suggestions
            function highlightSuggestion(index) {
                const items = suggestionsDiv.querySelectorAll('.suggestion-item');
                items.forEach((item, i) => {
                    item.classList.toggle('highlight', i === index);
                });
            }

             // Event listener for suggestion click
             suggestionsDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion-item')) {
                    const cursorPos = userInputField.selectionStart;
                    const fullText = userInputField.value;
                    const textBeforeCursor = fullText.substring(0, cursorPos);
                    const textAfterCursor = fullText.substring(cursorPos);
                    
                    // Find the current word position
                    const wordsBefore = textBeforeCursor.split(/(\s+)/);
                    const lastSegment = wordsBefore[wordsBefore.length - 1];
                    const replacement = e.target.textContent.trim();
                    
                    // Replace the current word
                    const newTextBefore = textBeforeCursor.substring(0, textBeforeCursor.length - lastSegment.length) + replacement;
                    userInputField.value = newTextBefore + textAfterCursor;
                    
                    // Move cursor to end of replacement
                    const newCursorPos = newTextBefore.length;
                    userInputField.setSelectionRange(newCursorPos, newCursorPos);
                    
                    suggestionsDiv.style.display = 'none';
                    currentSuggestionIndex = -1;
                    suggestionsDiv.innerHTML = '';
                }
            });
 
            function fetchTransliterationSuggestions(text) {
                // Split the text and take the last word for transliteration
                const words = text.split(' ');
                const currentWord = words[words.length - 1]; // Get the last word
                if (currentWord.length > 0) {
                    fetch(`/transliterate?text=${encodeURIComponent(currentWord)}&lang=${lang}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.suggestions && data.suggestions.length > 0) {
                                suggestionsDiv.innerHTML = data.suggestions.map((s, index) => 
                                    `<div class="suggestion-item" data-index="${index}">${s}</div>`).join('');
                                suggestionsDiv.style.display = 'block'; // Show suggestions
                                currentSuggestionIndex = 0; // Highlight the first suggestion
                                highlightSuggestion(currentSuggestionIndex);
                            } else {
                                suggestionsDiv.style.display = 'none'; // Hide if no suggestions
                                suggestionsDiv.innerHTML = '';
                            }
                        })
                        .catch(error => console.error('Error fetching transliteration suggestions:', error));
                } else {
                    suggestionsDiv.style.display = 'none'; // Hide suggestions if input is empty
                    suggestionsDiv.innerHTML = '';
                }
            }
        });
    </script>

    {% if session.login %}
        <!-- For audio upload (for some reason it only appears inside the survey modal lmao) -->
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="file" accept="audio/*" required>
            <button type="submit">Upload Audio</button>
        </form>

        <div id="response"></div>

        <script>
            $(document).ready(function() {
                $('#uploadForm').on('submit', function(e) {
                    e.preventDefault();
                    var formData = new FormData(this);

                    $.ajax({
                        url: '/upload',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function(data) {
                            sendRequestToPython('audio', data);
                        },
                        error: function(jqXHR) {
                            $('#response').html('<p>Error: ' + jqXHR.responseJSON.error + '</p>');
                        }
                    });
                });
            });
        </script>
    {% endif %}
{% endblock %}